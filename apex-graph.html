<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <title>Graphic</title>
    <style>

    </style>
</head>
<body>

    <div id="chart">
    </div>
    <script>

    getChart();
    function getChart() {
        const TIME_WORK = 8,
            SET_FIRSTHOUR = 6,
            debug_status = true,
            MAX_INT_TIME = 30;
        let checkIfAreThere = 0,
            startMinut = 0,
            theHoursGet = 10,
            categoriesChart = new Array(), // legend - time in half hour: 6:00, 6:30, 7:30 ... 16:30 without brakes - 30 minutes.
            dataChart = [ 0 ], // start with 0 minutes.
            remChart = new Array(); // black line

        // Time from X-Axis 

        for(let i = 0; i < getTimesArray(6, 17, 30).length; i++) {

            const result = new Date(Math.floor(hmsToSecondsOnly(getTimesArray(6, 17, 30)[i])) * 1000).toISOString().slice(11, 19);
            categoriesChart.push(result);
            startMinut++;
        }

        /* Update de Y Axis (How blue line are calc from getTimeRemain)  */
        for(let i = 0; i < dataChart.length; i++) { checkIfAreThere = i; }
        
        if(theHoursGet > 0) theHoursGet += (checkIfAreThere * MAX_INT_TIME);

        if(debug_status) console.log("debug: dataChart: " +dataChart.length);
        if(debug_status) console.log("debug: checkIfAreThere: " +checkIfAreThere);

        let calculateTime = 0,
            time = new Date(), 
            calculateTimeBeta = 0;

        let calculateFunction = () => {

            let d1 = new Date();
            let start = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate(), 6, 0, 0);
            let d2 = new Date();
            let now = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate(), d2.getHours(), d2.getMinutes(), d2.getSeconds());
            let timenow = now.toTimeString().substring(0, 8); // ultima actualizare la // scot data
            timenow = timenow.substring(0, 5);  // scot secundele
            let getTime = timenow;
            if(debug_status ) console.log("debug: getTimeWorked: " +getTime);
            if(debug_status ) console.log("debug: now time: " +now);
            if(debug_status ) console.log("debug: start time: " +start);


            let lucrate = (now - start) / 1000;  // 1000
            if (lucrate > 30600) lucrate = 28800; // time for 8.5 hours worked.
            else if (lucrate > 23400) lucrate = lucrate - 1800;
            else if (lucrate > 22800) lucrate = 21600;
            else if (lucrate > 12000) lucrate = lucrate - 1200;
            else if (lucrate > 10800) lucrate = 10800;
            if(debug_status ) console.log("debug: lucrate " +lucrate / 60); // this is in minutes.

            
            for (let i = 0; i < categoriesChart.length; i++) {
                dataChart.push((hmsToSecondsOnly(categoriesChart[i]) - lucrate));
                console.log(lucrate)
            }
            
        }
        calculateFunction();
        //if(time.getHours() >= SET_FIRSTHOUR) setInterval(calculateFunction, 2000); // check every 2 sec.

        /* Ajax Chart.js */ 
        var options = {
        series: [ {
            name: "Target",
            data: dataChart, 
        },{
            name: "Rem", 
            data: remChart,
        } ],
            chart: {
                height: 350,
                type: 'line',
                dropShadow: {
                    enabled: true,
                    color: '#000',
                    top: 18,
                    left: 7,
                    blur: 10,
                    opacity: 0.2
            },
                    toolbar: {
                    show: false
            }
        },
        colors: ['#77B6EA', '#545454'],
            dataLabels: {
            enabled: true,
        },
        stroke: {
            curve: 'smooth'
        },
        title: {
            text: 'Average Target & Rem time',
            align: 'left'
        },
        grid: {
            borderColor: '#e7e7e7',
            row: {
                colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
                opacity: 0.5
            },
        },
        markers: {
            size: 1
        },
        xaxis: {
            categories: categoriesChart, // time
            title: {
                text: 'Time X-Axis (6:00 - 14:30)'
            }
        },
        yaxis: {
            title: {
            text: 'Time'
        },
            min: 0,
            max: theHoursGet  // set averange
        },
            legend: {
            position: 'top',
            horizontalAlign: 'right',
            floating: true,
            offsetY: -25,
            offsetX: -5
        } 
    };

    var chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();
    }

    function chunkify(a, n, balanced) {
        
        if (n < 2)
            return [a];

        var len = a.length,
                out = [],
                i = 0,
                size;

        if (len % n === 0) {
            size = Math.floor(len / n);
            while (i < len) {
                out.push(a.slice(i, i += size));
            }
        }

        else if (balanced) {
            while (i < len) {
                size = Math.ceil((len - i) / n--);
                out.push(a.slice(i, i += size));
            }
        }

        else {

            n--;
            size = Math.floor(len / n);
            if (len % size === 0)
                size--;
            while (i < size * n) {
                out.push(a.slice(i, i += size));
            }
            out.push(a.slice(size * n));

        }
        return out;
    }

    //console.log(chunkify("1000000", 2, false));

    function secondsToHms(seconds) {
        if (!seconds) return '';

        let duration = seconds;
        let hours = duration / 3600;
        duration = duration % (3600);

        let min = parseInt(duration / 60);
        duration = duration % (60);

        let sec = parseInt(duration);

        if (sec < 10) {
            sec = `0${sec}`;
        }
        if (min < 10) {
            min = `0${min}`;
        }

        if (parseInt(hours, 10) > 0) {
            return `${parseInt(hours, 10)}h ${min}m ${sec}s`
        }
        else if (min == 0) {
            return `${sec}s`
        }
        else {
            return `${min}m ${sec}s`
        }
        }


    // function format(time) {
    //     // Hours, minutes and seconds
    //     var hrs = ~~(time / 3600);
    //     var mins = ~~((time % 3600) / 60);
    //     var secs = ~~time % 60;

    //     // Output like "1:01" or "4:03:59" or "123:03:59"
    //     var ret = "";
    //     if (hrs > 0) {
    //         ret += "" + hrs + ":" + (mins < 10 ? "0" : "");
    //     }
    //     ret += "" + String(mins).padStart(2, '0') + ":" + (secs < 10 ? "0" : "");
    //     ret += "" + secs;
    //     return ret;
    // }
    function toHoursAndMinutes(totalMinutes) {
        const minutes = totalMinutes % 60;
        const hours = Math.floor(totalMinutes / 60);

        return `${padTo2Digits(hours)}:${padTo2Digits(minutes)}`;
    }

    function padTo2Digits(num) {
        return num.toString().padStart(2, '0');
    }
    /* -------------------------------------------- */
    const subtractMinutes = (date,minutes) => new Date(date - minutes * 60000);

    const getPastMinutes = (minutes, startDate = new Date()) => {
    return [...Array(minutes)].map((i,idx) => {
        let newDate = subtractMinutes(startDate,idx);
        let hour = newDate.getHours().toString().padStart(2,'0');
        let minute = newDate.getMinutes().toString().padStart(2,'0');
        return `${hour}:${minute}`;
    });
    };


    // var items = ['html5', 'css', 'javascript', 'jquery'];
    // items.forEach((c,i) => setTimeout(() => console.log(c), i*1000))
    
    function getTimesArray(start, end, length) {
        let startMin = start * 60
        let endMin = end * 60
        let times = []

        while (startMin <= endMin){
            let mins = startMin % 60
            let hours = Math.floor(startMin / 60)
            let sec = 0;
            let timeString = hours.toString() + ":" +  mins.toString().padStart(2, '0') + ":" + sec.toString().padStart(2, '0')
            times.push(timeString)
            startMin += length
        }
        return times
    };

   
    /* Return hours, minutes or seconds in only seconds. */
    function hmsToSecondsOnly(strComm) {
        var p = strComm.split(':'),
            s = 0, m = 1;

        while (p.length > 0) {
            s += m * parseInt(p.pop(), 10);
            m *= 60;
        }

        return s;
    };
    
    //console.log((2 * 1800) / 3600); // ramane 18
    /* Add all values from one array */
    function getArraySum(a){
        var total=0;
        for(var i in a) { 
            total += a[i];
        }
        return total;
    }

    // var toHHMMSS = (secs) => {
    // var sec_num = parseInt(secs, 10)
    // var hours   = Math.floor(sec_num / 3600)
    // var minutes = Math.floor(sec_num / 60) % 60
    // var seconds = sec_num % 60

    //     return [hours,minutes,seconds]
    //         .map(v => v < 10 ? "0" + v : v)
    //         .filter((v,i) => v !== "00" || i > 0)
    //         .join(":")
    // }

    // console.log(toHHMMSS(23400));
    // console.log(getTimesArray(6, 17, 30))
    // console.log(getTimesArray(4,8, 110))
    // const seconds = 21660;
    // const result = new Date(seconds * 1000).toISOString().slice(11, 19);
    // console.log(typeof result); // debug "00:10:00" (hh:mm:ss)

    // Task:
    // array > creste y Axis > proces calcul (360 / 480) * (minute from x Axys)


    /*  
    - Seconde > calculate la / 60 - in minute > adaugate in array fiecare.    
        https://stackoverflow.com/questions/8188548/splitting-a-js-array-into-n-arrays
        https://dev.to/sarah_chima/the-javascript-array-map-method-44m0
    */


    </script>
</body>
</html>